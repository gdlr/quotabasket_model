---
title: "iterative_year"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(purrr)
```

This R-markdown iterates our function over a series of years.

For each year, this function will select the effort that maximizes PVNB within a constraint. Based on that effort and harvest, the loop will repeat for any number of years. 

```{r}
# Write a function that for a given stock size and effort, returns profit
profit_fx <- function(E, r, K, X, q, p, c){

#(E = 1, r = 0.1, K = 100, X = 50, q = 0.01, p = 1, c = 0.1){
  ## Stock size ##
  # Write a stock size equation
    stock <-  X + (r*X)*(1-X/K) - q*E*X
  ## Harvest ##
  #  And write an equation...
    harvest <-  q*E*X
  ## Profit
  # Write an equation...
    profit <-  p*harvest - c*E
  return(profit)
}


p_h_s_fx <- function(E, r, K, X, q, p, c){

#(E = 1, r = 0.1, K = 100, X = 50, years = 100, q = 0.01, p = 1, c = 0.1){

    ## Stock size ##
  # Write a stock size equation
    stock <-  X + (r*X)*(1-X/K) - q*E*X
  ## Harvest ##
  #  And write an equation...
    harvest <-  q*E*X
  ## Profit
  # Write an equation...
    profit <-  p*harvest - c*E
  lst <- c(stock, harvest, profit)
  return(lst)
}


```

```{r}
# For one species, can we run this function over a range of efforts? 
E_1 <- seq(0, 15, by = 0.5)
# Woooo this works
profits <- sapply(E_1, profit_fx)
# This returns the max value in this vector
which.max(profits)

profit_fx(25)
```
What about for two species?
```{r}
# Create a data frame of species parameters (these are our inputs)
pr <- data.frame(c(1:2))
pr$r <- c(1, 1)
pr$K <- c(10000, 10000)
pr$X0 <- c(5000, 5000)
pr$p <- c(200,200)
pr$c <- c(1,1)
pr$delta <- c(0.05,0.05)
pr$rho <- 1/(1+pr$delta)
pr$q <- c(0.005, 0.005)
```

```{r}
# I want to run the profit function for each species

# Generate effort df:
E_1 <- seq(0,1, 0.01)
E_2 <- seq(0, 1, 0.01)
# generate all the E1 and E2 combinations
effort_m <- data.matrix(expand_grid(E_1, E_2))


yearly_iteration_fx <- function(years){
  
    yearly_shp <- data.frame(E1 = 0, X1 = pr$X0[1], H1 = 0, P1 = 0,
                            E2 = 0, X2 = pr$X0[2], H2 = 0, P2 = 0)

    for(y in 2:years){

      prof_lst <- list()
      x_lst <- c(yearly_shp$X1[y-1], yearly_shp$X2[y-1]) # Set previous values for the starting stock
      
      for(i in 1:nrow(pr)){     # i effectively becomes species number
        
        p_wrapper <- function(E){   # This basically makes it so the function has the right variables
          r = pr$r[i]
          K = pr$r[i]
          X = x_lst[i]    
          p = pr$r[i]
          c = pr$c[i]
          q <- pr$q[i]
          
          stock <-  X + (r*X)*(1-X/K) - q*E*X
          harvest <-  q*E*X
          profit <-  p*harvest - c*E
          return(profit)
        }
        
        tmp <- NULL
        E_list <- effort_m[,i]             # Select the corresponding column of the effort matrix...
        tmp <- sapply(E_list, p_wrapper)   # Apply our profit function over all 
        prof_lst[[i]] <- tmp               # Bind it to a temp list for later use
      }
      
      p_matrix_tmp <- do.call(cbind, prof_lst)
      tot_prof_tmp <- rowSums(p_matrix_tmp)
      e_max <- which.max(tot_prof_tmp)
      
      e_max_comb <- c(unname(effort_m[e_max, 1]), unname(effort_m[e_max, 2]))  # Pull E values that return the highest profit
      
      # I need to write a new for loop here???
      lst_yr <- c()
      
      for(i in 1:nrow(pr)){
        phs_wrapper <- function(E){ # Same as function above...
           r = pr$r[i]
           K = pr$r[i]
           X = x_lst[i]      # I think we want to write our function so we can input a different X each time
           p = pr$r[i]
           c = pr$c[i]
           q = pr$q[i]
           stock <-  X + (r*X)*(1-X/K) - q*E*X
           harvest <-  q*E*X
           profit <-  p*harvest - c*E
           lst <- c(stock, harvest, profit)
           return(lst)
        }
              # We can run this for each max effort
        lst_yr <- unlist(lapply(e_max_comb, phs_wrapper))   # Gives an output vector
      
      yearly_shp <- yearly_shp %>% add_row(E1 = e_max_comb[1],
                                            X1 = lst_yr[1],
                                            H1 = lst_yr[2],
                                            P1 = lst_yr[3],
                                            E2 = e_max_comb[2],
                                            X2 = lst_yr[4],
                                            H2 = lst_yr[5],
                                            P2 = lst_yr[6])

      }
    }
  return(yearly_shp)
}
```

```{r}
test <- yearly_iteration_fx(50)
```
