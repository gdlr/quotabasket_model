---
title: <center>Sensitivity Analysis
output: html_document
---

This RMD is used for sensitivity analysis for each parameters: r, K, X0, p, E, C, and the catchability coefficient matrix. 

The results are stored in dataframe [parameterName_result]
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Packages
library(tidyverse)
library(Matrix)
library(kableExtra)
library(ggplot2)
library(plotly)
library(lpSolve)
library(lpSolveAPI)
```

```{r}
source("stock_dynamic.R")
source("harvest_species.R")
source("harvest_tech.R")
source("profit_tech.R")
source("pvnb.R")
```


```{r} 
### This code chunk will set up the initial parameters. Each of the parameter will subject to change in the third code chunk. 

# First, set seed to ensure we have the same result 
set.seed(666)


# set the number of species and technologies we want to study
species_num <- 2
tech_num <- 2


# set the number of years we want to model the stock dynamic 
year = 5

# set the discount rate
delta = 0.05
rho = 1/(1+delta)

# set values for variables in the "Our Model" section
# set parameters

r <- runif(species_num, min = 0, max = 2)
K <- runif(species_num, min = 0.8, max = 2)
X0 <- runif(species_num, min = 0.5, max = 1.5)
p <- runif(species_num, min = 50, max = 400)
c <- runif(species_num, min = 0.01, max = 3)

# set catchability coefficient 
coefficient <- runif(species_num*tech_num, min = 0.01, max = 1)
q_matrix <- matrix(coefficient, nrow = tech_num, ncol = species_num)

# set effort for each tech 
E <- runif(tech_num, min = 0, max = 8)

# set cost for each tech
C <- runif(tech_num, min = 0, max = 3)
```


### Sensitivity Analysis for r
```{r}
### This code chunk will generate parameters for sensitivity analysis

# generate all combinations of r 
# I set the range of r to be 0-2, step length to be 0.1. So there are a total number of 2/0.1 r. Since we have [species_num] species, the code will generate all the combinations of [r1, r2, r3, r4,...,r_species_num]. 
all_r = seq(0,2,0.1)
r_result = expand.grid(replicate(species_num, all_r, F))
```

```{r}
# plug in r to calculate PVNB
pvnb_vec <- NULL
for(i in 1:nrow(r_result)){
   tmp_r <- (t(r_result[i,]))
   tmp_pvnb <- pvnb(tmp_r,K,X0, p,c,E,C, q_matrix)
   pvnb_vec <- append(pvnb_vec,tmp_pvnb)
}

r_result$PVNB <- pvnb_vec
```


### Sensitivity Analysis for K
```{r}
### This code chunk will generate parameters for sensitivity analysis

# generate all combinations of K 
# I set the range of K to be 1-2.5, step length to be 0.1.
all_K = seq(0.8,2,0.1)
K_result = expand.grid(replicate(species_num, all_K, F))
```

```{r}
# plug in K to calculate PVNB
pvnb_vec <- NULL
for(i in 1:nrow(K_result)){
   tmp_K <- t(K_result[i,])
   tmp_pvnb <- pvnb(r,tmp_K,X0, p,c,E,C, q_matrix)
   pvnb_vec <- append(pvnb_vec,tmp_pvnb)
}

K_result$PVNB <- pvnb_vec
```


### Sensitivity Analysis for X0
```{r}
### This code chunk will generate parameters for sensitivity analysis


# generate all combinations of X0 
# I set the range of X0 to be 0.3-1, step length to be 0.1.
all_X0 = seq(0.3,1,0.1)
X0_result = expand.grid(replicate(species_num, all_X0, F))
```

```{r}
# plug in X0 to calculate PVNB
pvnb_vec <- NULL
for(i in 1:nrow(X0_result)){
   tmp_X0 <- t(X0_result[i,])
   tmp_pvnb <- pvnb(r,K,tmp_X0, p,c,E,C, q_matrix)
   pvnb_vec <- append(pvnb_vec,tmp_pvnb)
}

X0_result$PVNB <- pvnb_vec
```


### Sensitivity Analysis for p
```{r}
### This code chunk will generate parameters for sensitivity analysis


# generate all combinations of p
# I set the range of p to be 50-400, step length to be 5.
all_p = seq(50,400,5)
p_result = expand.grid(replicate(species_num, all_p, F))
```

```{r}
# plug in X0 to calculate PVNB
pvnb_vec <- NULL
for(i in 1:nrow(p_result)){
   tmp_p <- t(p_result[i,])
   tmp_pvnb <- pvnb(r,K,X0, tmp_p,c,E,C, q_matrix)
   pvnb_vec <- append(pvnb_vec,tmp_pvnb)
}

p_result$PVNB <- pvnb_vec
```

### Sensitivity Analysis for catchability coefficient 
```{r}
### This code chunk will generate parameters for sensitivity analysis


# generate all combinations of catchability coefficient
# I set the range of the coefficient of one technology to be 0-1.
all_cat = seq(0,1,0.1)

# Choose [species_num] numbers from all_cat: each tech can catch [species_num] numbers of species). List out all the combination of all_cat choose [species_num].
all_cat_combn = expand.grid(replicate(species_num*tech_num,all_cat, F))
```

```{r}
# plug in catchability coefficient to calculate PVNB
pvnb_vec <- NULL
coef_result <- NULL
for(i in 1: nrow(all_cat_combn)){
   tmp_q = matrix(as.numeric(all_cat_combn[i,]), nrow = tech_num, ncol=species_num, byrow=T)
   tmp_pvnb <- pvnb(r,K,X0, p,c,E,C,tmp_q)
   pvnb_vec <- append(pvnb_vec,tmp_pvnb)
   coef_result <- rbind(coef_result, all_cat_combn[i,])
}

# in the coef dataframe, the coefficient matrix is convert into a 1-dimention vector, ie, Var1 = spe1, tech1; Var2 = spe2, tech1; Var3 = spe1, tech2; Var4 = spe2, tech2
coef_result$PVNB <- pvnb_vec
```

### Sensitivity Analysis for E
```{r}
### This code chunk will generate parameters for sensitivity analysis


# generate all combinations of E
# I set the range of E to be 0-8, step length to be 0.5.
all_E = seq(0,8,0.5)
E_result = expand.grid(replicate(tech_num, all_E, F))

```

```{r}
# plug in E to calculate PVNB
pvnb_vec <- NULL
for(i in 1:nrow(E_result)){
   tmp_E <- as.numeric(E_result[i,])
   tmp_pvnb <- pvnb(r,K,X0, p,c,tmp_E,C, q_matrix)
   pvnb_vec <- append(pvnb_vec,tmp_pvnb)
}

E_result$PVNB <- pvnb_vec
```

### Sensitivity Analysis for C
```{r}
### This code chunk will generate parameters for sensitivity analysis

# generate all combinations of C
# I set the range of C to be 0-4, step length to be 0.5.
all_C = seq(0,4,0.5)
C_result = expand.grid(replicate(tech_num, all_C, F))

```

```{r}
# plug in C to calculate PVNB
pvnb_vec <- NULL
for(i in 1:nrow(C_result)){
   tmp_C <- as.numeric(C_result[i,])
   tmp_pvnb <- pvnb(r,K,X0, p,c,E,tmp_C, q_matrix)
   pvnb_vec <- append(pvnb_vec,tmp_pvnb)
}

C_result$PVNB <- pvnb_vec
```

